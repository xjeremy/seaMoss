<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>OpenSeadragon SVG Overlay</title>
	<style>
		html, body {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		#openseadragon {
			width: 100%;
			height: 100%;
		}
		#exif {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.5);
			color: #fff;
			font-family: sans-serif;
			font-size: 12px;
			padding: 10px;
			display: none;
		}
	</style>
</head>
<body>
	<div id="openseadragon"></div>
	<div id="exif"></div>
	<script src="/public/js/openseadragon.min.js"></script>
	<script src="/public/js/openseadragon-svg-overlay.js"></script>
	<script src="/public/js/exif.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js" integrity="sha256-Xb6SSzhH3wEPC4Vy3W70Lqh9Y3Du/3KxPqI2JHQSpTw=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		var viewer = OpenSeadragon({
			id: "openseadragon",
			prefixUrl: "/public/images/",
			tileSources: [],
			animationTime: 1.5,
			springStiffness: 3
		});
		
		//Attach SVG Overlay
		var overlay = viewer.svgOverlay();
		
		//Add Some SVG
		// var d3Rect = d3.select(overlay.node()).append("rect")
		// 	.style('fill', '#f00')
		// 	.attr("x", 0)
		// 	.attr("width", 500)
		// 	.attr("y", 0)
		// 	.attr("height", 500);
			
		window.addEventListener("resize", function(){
			overlay.resize();
		});
		
		var tileSources = {
			name: "grand_canyon0",
			tileSource: '/photos/img_0/dzc_output.xml',
			childLayout: 'vertical',
			width: 3648,
			height: 2432,
			children: [
				{
					name: "grand_canyon1",
					tileSource: '/photos/img_1/dzc_output.xml',
					width: 3648,
					height: 2432,
					childLayout: 'horizontal',
					children: [
						{
							name: "grand_canyon1",
							tileSource: '/photos/img_1/dzc_output.xml',
							width: 3648,
							height: 2432
						},
						{
							name: "grand_canyon2",
							tileSource: '/photos/img_2/dzc_output.xml',
							width: 3648,
							height: 2432
						},
						{
							name: "grand_canyon3",
							tileSource: '/photos/img_3/dzc_output.xml',
							width: 3648,
							height: 2432
						}
					]
				},
				{
					name: "grand_canyon2",
					tileSource: '/photos/img_2/dzc_output.xml',
					width: 3648,
					height: 2432
				},
				{
					name: "grand_canyon3",
					tileSource: '/photos/img_3/dzc_output.xml',
					width: 3648,
					height: 2432
				},
				{
					name: "grand_canyon4",
					tileSource: '/photos/img_4/dzc_output.xml',
					width: 3648,
					height: 2048,
					childLayout: 'vertical',
					children: [
						{
							name: "grand_canyon1",
							tileSource: '/photos/img_1/dzc_output.xml',
							width: 3648,
							height: 2432
						},
						{
							name: "grand_canyon2",
							tileSource: '/photos/img_2/dzc_output.xml',
							width: 3648,
							height: 2432
						},
						{
							name: "grand_canyon3",
							tileSource: '/photos/img_3/dzc_output.xml',
							width: 3648,
							height: 2432
						},
						{
							name: "grand_canyon4",
							tileSource: '/photos/img_4/dzc_output.xml',
							width: 3648,
							height: 2048
						}
					]
				},
				{
					name: "celestial",
					type:"zoomifytileservice",
					width: 11472,
					height: 6429,
					tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/opo0328a/",
					childLayout: 'horizontal',
					children: [
						{
							type:"zoomifytileservice",
							width: 108199,
							height: 81503,
							tilesUrl: "https://cdn.eso.org/images/zoomable/eso1242a/",
						},
						{
							type:"zoomifytileservice",
							width: 29566,
							height: 14321,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0707a/",
						},
						{
							type:"zoomifytileservice",
							width: 3179,
							height: 3179,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1310a/",
						},
						{
							type:"zoomifytileservice",
							width: 17043,
							height: 11710,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic2007a/",
						},
						{
							type:"zoomifytileservice",
							width: 8919,
							height: 6683,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1509a/",
						},
						{
							type:"zoomifytileservice",
							width: 6780,
							height: 7071,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1501a/",
						},
						{
							type:"zoomifytileservice",
							width: 7857,
							height: 7462,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1608a/",
						},
						{
							type:"zoomifytileservice",
							width: 4240,
							height: 4211,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/potw1345a/",
						},
						{
							type:"zoomifytileservice",
							width: 2704,
							height: 2826,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1307a/",
						},
						{
							type:"zoomifytileservice",
							width: 7910,
							height: 6178,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1302a/",
						},
						{
							type:"zoomifytileservice",
							width: 3897,
							height: 3044,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1104a/",
						},
						{
							name: "Hubble Ultra Deep Field",
							infoUrl: "https://www.spacetelescope.org/images/heic0406a/",
							type:"zoomifytileservice",
							width: 6200,
							height: 6200,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0406a/",
						},
						{
							name: "Crab Nebula",
							infoUrl: "https://www.spacetelescope.org/images/heic0515a/",
							type:"zoomifytileservice",
							width: 3864,
							height: 3864,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0515a/",
						},
						{
							name: "The Lagoon Nebula",
							infoUrl: "https://www.spacetelescope.org/images/heic1808a/",
							type:"zoomifytileservice",
							width: 4782,
							height: 6028,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1808a/",
						},
						{
							name: "Orion Nebula",
							infoUrl: "https://www.spacetelescope.org/images/heic0601a/",
							type:"zoomifytileservice",
							width: 18000,
							height: 18000,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0601a/",
						},
						{
							name: "Whirlpool Galaxy (M51) and companion galaxy",
							infoUrl: "Whirlpool Galaxy (M51) and companion galaxy",
							type:"zoomifytileservice",
							width: 11477,
							height: 7965,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0506a/",
						},
						{
							name: "Stellar spire in the Eagle Nebula",
							infoUrl: "https://www.spacetelescope.org/images/heic0506b/",
							type:"zoomifytileservice",
							width: 3857,
							height: 7804,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0506b/",
						},
						{
							name: "Barred spiral galaxy NGC 1300",
							infoUrl: "https://www.spacetelescope.org/images/opo0501a/",
							type:"zoomifytileservice",
							width: 6637,
							height: 3787,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/opo0501a/",
						},
						{
							name: "Merging Galaxies",
							infoUrl: "https://www.spacetelescope.org/images/heic0206b/",
							type:"zoomifytileservice",
							width: 3857,
							height: 2893,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0206b/",
						},
						{
							name: "Messier 106",
							infoUrl: "https://www.spacetelescope.org/images/heic1302a/",
							type:"zoomifytileservice",
							width: 7910,
							height: 6178,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1302a/",
						},
						{
							name: "Galactic wreckage in Stephan's Quintet",
							infoUrl: "https://www.spacetelescope.org/images/heic0910i/",
							type:"zoomifytileservice",
							width: 6064,
							height: 6760,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0910i/",
						},
						{
							name: "Edge-on view of NGC 5866",
							infoUrl: "https://www.spacetelescope.org/images/opo0624a/",
							type:"zoomifytileservice",
							width: 3190,
							height: 3756,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/opo0624a/",
						},
						{
							name: "Pinwheel Galaxy Messier 101",
							infoUrl: "https://www.spacetelescope.org/images/heic0602a/",
							type:"zoomifytileservice",
							width: 15852,
							height: 12392,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0602a/",
						},
						{
							name: "Gravitational Lensing from galaxy cluster Abell 2218",
							infoUrl: "https://www.spacetelescope.org/images/heic0814a/",
							type:"zoomifytileservice",
							width: 4739,
							height: 4504,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0814a/",
						},
						{
							name: "Saturn",
							infoUrl: "https://www.spacetelescope.org/images/heic1917a/",
							type:"zoomifytileservice",
							width: 2505,
							height: 1592,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1917a/",
							childLayout: 'horizontal',
							children: [
								{
									name: "Saturn's aurorae",
									infoUrl: "https://www.spacetelescope.org/images/heic0504a/",
									type:"zoomifytileservice",
									width: 2598,
									height: 2598,
									tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic0504a/",
								}
							]
						},
						{
							name: "Jupiter",
							infoUrl: "https://www.spacetelescope.org/images/heic1914a/",
							type:"zoomifytileservice",
							width: 3050,
							height: 3050,
							tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1914a/",
							childLayout: 'horizontal',
							children: [
								{
									name: "Jupiter Close-up",
									infoUrl: "https://www.spacetelescope.org/images/heic1914b/",
									type:"zoomifytileservice",
									width: 7200,
									height: 3196,
									tilesUrl: "https://cdn.spacetelescope.org/archives/images/zoomable/heic1914b/",
								}
							]
						}
					]
				}
			]
		};
		var tiles = d3.hierarchy(tileSources)
			.descendants()
			.map(function(item){
				return item.data;
			});
		/*
		tiles.forEach(function(tile){
		debugger;
			var image = {
				width: tile.width,
				tileSource: tile.tileSource,
				success: function(event) {debugger;
					self.tiledImage = event.item;
				}
			}
			viewer.addTiledImage(image);
		});
		*/
		viewer.open(tiles);
		
		viewer.addHandler('canvas-click', function(event) {
			if (!event.quick) {
				return;
			}
	
			var photo = hitTest(event.position);
			if (photo) {
				console.log(photo);
				debugger;
				viewer.viewport.fitBounds(photo.getBounds(), false);
				//self.select(photo);
			}
		});
		
		function getExif(imgId){
			var img = document.getElementById(imgId);
            EXIF.getData(img, function() {
                var make = EXIF.getTag(this, "Make");
                var model = EXIF.getTag(this, "Model");
                var makeAndModel = document.getElementById("makeAndModel");
                makeAndModel.innerHTML = `${make} ${model}`;
            });
		}

		function hitTest(pixel) {
		  var pos = this.viewer.viewport.pointFromPixel(pixel);
	
		  var photo = viewer.world._items.find(function(v, i) {
			var box = v.getBounds();debugger;
			return (pos.x > box.x && pos.y > box.y && pos.x < box.x + box.width && pos.y < box.y + box.height);
		  });
		  return photo;
		}
		
		//Nested parent-child
		//
		function layoutTreeMap(tileSources){
			var tiles = d3.hierarchy(tileSources);
			
			//Recursively size the children bottom-up
			recursiveResize(tiles);
			function recursiveResize(node, layoutOffset){
				
				//Container dims will grow to hold children, and original dims will be used for scaling this image
				node.data.containerWidth = node.data.width;
				node.data.containerHeight = node.data.height;
				node.data.scale = 1;
				
				//Justify Children
				if (node.children){
				
					//Recursion - child-first, bottom-up
					node.children.forEach(function(child){
						recursiveResize(child);
					});
					
					var stripDims = { width: 0, height: 0 }
					
					//Sync children dimensions for tile strip
					if (node.data.childLayout == 'vertical'){
						var childMinWidth = d3.min(node.children, function(child){ return child.data.containerWidth; });
						node.children.forEach(function(child){
							child.data.scale = childMinWidth / child.data.containerWidth;
						});
						stripDims = {
							width: childMinWidth,
							height: d3.sum(node.children, function(child){ return child.data.containerHeight * child.data.scale; })
						}
					} else {
						var childMinHeight = d3.min(node.children, function(child){ return child.data.containerHeight; });
						node.children.forEach(function(child){
							child.data.scale = childMinHeight / child.data.containerHeight;
						});
						stripDims = {
							width: d3.sum(node.children, function(child){ return child.data.containerWidth * child.data.scale; }),
							height: childMinHeight
						}
					}
					
					//Scale child strip to match parent dimensions
					var stripScale = node.data.childLayout == 'vertical' ? node.data.height / stripDims.height : node.data.width / stripDims.width;
					node.children.forEach(function(child){
						child.data.scale = child.data.scale * stripScale;
					});
					stripDims = {
						width: stripDims.width * stripScale,
						height: stripDims.height * stripScale
					}
					
					//Adjust container dims to include child strip
					if (node.data.childLayout == 'vertical'){
						node.data.containerWidth = node.data.containerWidth + stripDims.width;
					} else {
						node.data.containerHeight = node.data.containerHeight + stripDims.height;
					}
				}
			}
			
			//Recursively position the children top-down
			recursivePosition(tiles, 1);
			function recursivePosition(node, parentScale){
				node.data.x = node.data.x || 0;
				node.data.y = node.data.y || 0;
				
				var cumulativeScale = parentScale * node.data.scale;
				
				if (node.children){
					//Resize children
					node.children.forEach(function(child){
						child.data.width = child.data.width * cumulativeScale * child.data.scale;
						child.data.height = child.data.height * cumulativeScale * child.data.scale;
						child.data.containerWidth = child.data.containerWidth * cumulativeScale * child.data.scale;
						child.data.containerHeight = child.data.containerHeight * cumulativeScale * child.data.scale;
					});
					
					//Position children
					if (node.data.childLayout == 'vertical'){
						childHeightTotal = 0;
						node.children.forEach(function(child){
							child.data.x = node.data.x + node.data.width;
							child.data.y = node.data.y + childHeightTotal;
							childHeightTotal += child.data.containerHeight;
						});
						
					} else {
						childWidthTotal = 0;
						node.children.forEach(function(child){
							child.data.x = node.data.x + childWidthTotal;
							child.data.y = node.data.y + node.data.height;
							childWidthTotal += child.data.containerWidth;
						});
					}
					
					//Recursion
					node.children.forEach(function(child){
						recursivePosition(child, cumulativeScale);
					});
				}
			}
			
			//Update images
			var flatTileSources = tiles.descendants();
			flatTileSources.forEach(function(tile, i){
				var tiledImage = viewer.world.getItemAt(i);
				tiledImage.setHeight(tile.data.height);
				tiledImage.setPosition(new OpenSeadragon.Point(tile.data.x, tile.data.y));
			});
			
			//Re-center
			viewer.viewport.fitBounds(viewer.world.getHomeBounds(), true);
		}
		
		//Justified Grid
		function layoutJustifiedGrid(tileSources){
			var tiles = d3.hierarchy(tileSources);
			
			//Update images
			var flatTileSources = tiles.descendants();
			var columns = Math.ceil(Math.sqrt(flatTileSources.length));
			var rows = Math.ceil(flatTileSources.length / columns);
			var worldHeight = viewer.world.getHomeBounds().height;
			var rowHeight = Math.round(worldHeight / rows);
			var margin = rowHeight * 0.05;
			var runningWidth = 0;
			
			flatTileSources.forEach(function(tile, i){
				var column = i % columns;
				if (column == 0){ runningWidth = 0; }
	
				var tiledImage = viewer.world.getItemAt(i);
				var row = Math.floor(i / columns);
				var y = row * (rowHeight+ margin);
	
				//Set the new height and position of the image
				tiledImage.setHeight(rowHeight);
				tiledImage.setPosition(new OpenSeadragon.Point(runningWidth, y));
	
				runningWidth += tiledImage.getBounds().width + margin;
			});
			
			//Re-center
			viewer.viewport.fitBounds(viewer.world.getHomeBounds(), true);
		}
		
		//Parent Rows
		function layoutParentRows(tileSources){
			var rowHeight = 100
			var margin = rowHeight * 0.05;
			var tiles = d3.hierarchy(tileSources);
			
			//Recursively Arrange rows
			recursiveResize(tiles);
			function recursiveLayout(node, parentHeight){
				var runningWidth = 0;
				
				//Justify Children
				if (node.children){
				
					//Recursion
					node.children.forEach(function(child, i){
						debugger;
						recursiveLayout(child);
					});
				}
			}
			
			//Update images
			var flatTileSources = tiles.descendants();
			flatTileSources.forEach(function(tile, i){
				var column = i % columns;
				if (column == 0){ runningWidth = 0; }
	
				var row = Math.floor(i / columns);
				var tiledImage = viewer.world.getItemAt(i);
				var y = row * (rowHeight + margin);
	
				tiledImage.setHeight(rowHeight);
				tiledImage.setPosition(new OpenSeadragon.Point(runningWidth, y));
	
				runningWidth += tiledImage.getBounds().width + margin;
			});
			
			//Re-center
			viewer.viewport.fitBounds(viewer.world.getHomeBounds(), true);
		}
		
		//Temp standin to update layout
		function click(){
			// layoutJustifiedGrid(tileSources);
			debugger;
			layoutTreeMap(tileSources);
			// layoutParentRows(tileSources);
		}
		
		setTimeout(function(){
			click(); 
		}, 1000);
		
		
		
		(function() {
	
	  // ----------
	  window.App = {
		// ----------
		init: function() {
		  var self = this;
	
		  this.photos = [];
	
		  this.viewer = OpenSeadragon({
			  id: "openseadragon",
			  preserveViewport: true,
			  zoomPerScroll: 1.1,
			  prefixUrl: "../lib/openseadragon/images/"
		  });
	
		  this.viewer.viewport.fitBounds(new OpenSeadragon.Rect(-4, -4, 8, 8), true);
	
		  var $viewer = $(this.viewer.element).on('mousemove', function(event) {
			self.hoverPhoto = self.hitTest(new OpenSeadragon.Point(event.clientX, event.clientY));
			$viewer.css({
			  cursor: self.hoverPhoto ? 'pointer' : 'default'
			});
		  });
	
		  this.viewer.addHandler('zoom', function(event) {
			  self.updateButtons();
		  });
	
		  this.viewer.addHandler('pan', function(event) {
			  self.updateButtons();
		  });
	
		  this.viewer.addHandler('canvas-click', function(event) {
			if (!event.quick) {
			  return;
			}
	
			var photo = self.hitTest(event.position);
			if (photo) {
			  self.select(photo);
			}
		  });
	
		  this.svgNode = this.viewer.svgOverlay();
	
		  $(window).resize(function() {
			  self.viewer.svgOverlay('resize');
		  });
		  
		  this.flickrRequest({
			method: 'interestingness.getList',
			content: {
			  per_page: 40,
			  extras: 'tags,owner_name'
			},
			success: function(data) {
			  self.processPhotos(data, new OpenSeadragon.Point(0, 0), function() {
				if (self.auto) {
				  self.startAuto();
				}
			  });
			}
		  });
	
		  this.frame();
		},
	
		// ----------
		startAuto: function() {
		  var self = this;
	
		  setTimeout(function() {
			var index = Math.floor(Math.random() * self.photos.length);
			var photo = self.photos[index];
			self.select(photo);
			setTimeout(function() {
			  var tagIndex = Math.floor(Math.random() * photo.tags.length);
			  var tag = photo.tags[tagIndex];
			  self.loadForTag(tag, function() {
				self.startAuto();
			  });
			}, 5000);
		  }, 5000);
		},
	
		// ----------
		select: function(photo) {
		  if (this.selectedPhoto) {
			this.selectedPhoto.deselect();
		  }
	
		  if (photo) {
			this.viewer.world.setItemIndex(photo.tiledImage, this.viewer.world.getItemCount() - 1);
			this.fitPhoto(photo, App.isTouch ? 0.05 : 0.3);
			photo.select();
		  }
	
		  this.showTags(photo);
		  this.selectedPhoto = photo;
		},
	
		// ----------
		loadForTag: function(tag, onDone) {
		  var self = this;
	
		  if (this.selectedPhoto) {
			this.fitPhoto(this.selectedPhoto, 1.5);
		  } else {
			this.viewer.viewport.zoomBy(0.5);
		  }
	
		  this.select(null);
		  this.spin(true);
	
		  this.flickrRequest({
			method: 'photos.search',
			content: {
			  per_page: 10,
			  extras: 'tags,owner_name',
			  sort: 'interestingness-desc',
			  tags: tag.getText()
			},
			success: function(data) {
			  var pos;
			  if (self.isTouch) {
				pos = self.viewer.viewport.getBounds(true).getCenter();
			  } else {
				pos = tag.getPosition();
			  }
	
			  self.processPhotos(data, pos, onDone);
			},
			error: function() {
			  if (onDone) {
				onDone();
			  }
			}
		  });
		},
	
		// ----------
		processPhotos: function(data, center, onDone) {
		  var self = this;
	
		  if (!data || !data.photos || !data.photos.photo || !data.photos.photo.length) {
			console.error('[App.processPhotos] bad data', data);
			if (onDone) {
			  onDone();
			}
	
			return;
		  }
	
		  var expected = data.photos.photo.length;
		  var done = 0;
	
		  var increment = function() {
			done++;
			if (done === expected && onDone) {
			  onDone();
			}
		  };
	
		  // console.log(data);
		  _.each(data.photos.photo, function(v, i) {
			self.flickrRequest({
			  method: 'photos.getSizes',
			  content: {
				photo_id: v.id
			  },
			  success: function(data2) {
				// console.log(data2);
				setTimeout(function() {
				  new self.Photo({
					sizes: data2.sizes.size,
					x: center.x + ((Math.random() - 0.5) * 3),
					y: center.y + ((Math.random() - 0.5) * 1),
					tags: v.tags,
					ownerName: v.ownername,
					pageUrl: 'https://www.flickr.com/photos/' + v.owner + '/' + v.id,
					title: v.title,
					onLoad: function() {
					  self.spin(false);
					  increment();
					},
					onError: function() {
					  increment();
					}
				  });
				}, 200 * i);
			  },
			  error: function() {
				increment();
			  }
			});
			// console.log(v.o_width);
		  });
		},
	
		// ----------
		getAdjustment: function(itemBox, boxes) {
		  var self = this;
	
		  var output = new OpenSeadragon.Point(0, 0);
		  var itemCenter = itemBox.getCenter();
	
		  _.each(boxes, function(box) {
			if (itemBox === box) {
			  return;
			}
	
			var intersection = self.intersection(itemBox, box);
			if (!intersection) {
			  return;
			}
	
			var diff = itemCenter.minus(box.getCenter());
			if (itemBox.width < box.width / 2) {
			  if (Math.abs(diff.x) > Math.abs(diff.y)) {
				  output.x += self.sign(diff.x) * intersection.width;
				} else {
				  output.y += self.sign(diff.y) * intersection.height;
				}
			} else {
			  if (intersection.width < intersection.height) {
				output.x += self.sign(diff.x) * intersection.width;
			  } else {
				output.y += self.sign(diff.y) * intersection.height;
			  }
			}
		  });
	
		  var limit = 0.1;
		  output.x = Math.min(limit, Math.max(-limit, output.x));
		  output.y = Math.min(limit, Math.max(-limit, output.y));
		  return output;
		},
	
		// ----------
		frame: function() {
		  var self = this;
	
		  requestAnimationFrame(function() {
			self.frame();
		  });
	
		  var photoBoxes = [];
	
		  _.each(this.photos, function(photo) {
			photo.frame();
			photo.box = photo.getBounds();
			photoBoxes.push(photo.box);
		  });
	
		  _.each(this.photos, function(photo) {
			if (!photo.drawn || photo === self.selectedPhoto) {
			  photo.diff = new OpenSeadragon.Point(0, 0);
			  return;
			}
	
			photo.diff = self.getAdjustment(photo.box, photoBoxes);
		  });
	
		  // this.maxSpeed = this.maxSpeed || 0;
	
		  _.each(this.photos, function(photo) {
			if (photo.diff.x || photo.diff.y) {
			  // self.maxSpeed = Math.max(photo.diff.x, photo.diff.y, self.maxSpeed);
			  var pos = photo.getPosition()
				.plus(photo.diff.times(0.2));
	
			  photo.setPosition(pos);
			}
		  });
	
		  if (this.selectedPhoto) {
			var buffer = 0.01;
			var tagBoxes = [];
			tagBoxes.push(this.selectedPhoto.box);
	
			_.each(this.selectedPhoto.tags, function(tag) {
			  tag.box = tag.getBounds();
			  tag.box.x -= buffer;
			  tag.box.y -= buffer;
			  tag.box.width += buffer * 2;
			  tag.box.height += buffer * 2;
			  tagBoxes.push(tag.box);
			});
	
			_.each(this.selectedPhoto.tags, function(tag) {
			  tag.diff = self.getAdjustment(tag.box, tagBoxes);
			});
	
			_.each(this.selectedPhoto.tags, function(tag) {
			  if (tag.diff.x || tag.diff.y) {
				var pos = tag.getPosition()
				  .plus(tag.diff.times(0.2));
	
				tag.setPosition(pos);
			  }
			});
		  }
	
		  // console.log(self.maxSpeed);
		  this.viewer.forceRedraw();
		},
	
		// ----------
		fitPhoto: function(photo, buffer) {
		  var box = photo.getTargetBounds();
		  box.x -= buffer;
		  box.y -= buffer;
		  box.width += buffer * 2;
		  box.height += buffer * 2;
		  this.viewer.viewport.fitBounds(box);
		},
	
		// ----------
		getFocusedPhoto: function() {
		  var self = this;
	
		  if (!this.viewer) {
			return null;
		  }
	
		  var box = this.viewer.viewport.getBounds(true);
		  if (box.width > 2 && box.height > 2) {
			return null;
		  }
	
		  var pos = box.getCenter();
		  var best;
		  _.each(this.photos, function(v, i) {
			var center = v.getBounds().getCenter();
			var distance = self.distance(pos, center);
			if (!best || best.distance > distance) {
			  best = {
				photo: v,
				distance: distance
			  };
			}
		  });
	
		  return best ? best.photo : null;
		},
	
		// ----------
		updateButtons: function() {
		  if (!this.selectedPhoto) {
			return;
		  }
	
		  var photoBounds = this.selectedPhoto.getBounds();
		  var viewBounds = this.viewer.viewport.getBounds(false);
		  var intersection = this.intersection(photoBounds, viewBounds);
	
		  var photoArea = photoBounds.width * photoBounds.height;
		  var viewArea = viewBounds.width * viewBounds.height;
		  var intersectionArea = intersection ? intersection.width * intersection.height : 0;
	
		  if ((intersectionArea < viewArea * 0.5 && intersectionArea < photoArea * 0.33) || photoArea < viewArea * 0.10) {
			this.select(null);
		  }
		},
	
		// ----------
		hitTest: function(pixel) {
		  var pos = this.viewer.viewport.pointFromPixel(pixel);
	
		  var photo = _.find(this.photos, function(v, i) {
			var box = v.getBounds();
			return (pos.x > box.x && pos.y > box.y && pos.x < box.x + box.width && pos.y < box.y + box.height);
		  });
	
		  return photo;
		},
	
		// ----------
		showTags: function(photo) {
		  var self = this;
	
		  if (this.isTouch) {
			return;
		  }
	
		  _.each(this.photos, function(v, i) {
			_.each(v.tags, function(v2, i2) {
			  v2.hide();
			});
		  });
	
		  if (photo) {
			var box = photo.getBounds();
			var tl = box.getTopLeft();
	
			_.each(photo.tags, function(v, i) {
			  v.setPosition(new OpenSeadragon.Point(tl.x + (Math.random() * box.width), tl.y + (Math.random() * box.height)));
			  v.show();
			});
		  }
		},
	
		// ----------
		showMobileTags: function() {
		  var self = this;
	
		  if (!this.selectedPhoto) {
			return;
		  }
	
		  this.selectedPhoto.deselect();
	
		  $('.info-button').hide();
		  $('.tag-list-container').show();
		  var $list = $('.tag-list .content');
	
		  _.each(this.selectedPhoto.tags, function(v, i) {
			$('<div class="unit">' + v.getText() + '</div>')
			  .click(function(event) {
				event.preventDefault();
				event.stopPropagation();
				self.hideMobileTags();
				self.loadForTag(v);
			  })
			  .appendTo($list);
		  });
		},
	
		// ----------
		hideMobileTags: function() {
		  $('.info-button')
			.show();
	
		  $('.tag-list-container')
			.hide();
	
		  $('.tag-list .content')
			.empty();
	
		  if (this.selectedPhoto) {
			this.selectedPhoto.select();
		  }
		},
	
		// ----------
		inside: function(point, rect) {
		  return (point.x >= rect.x && point.x < rect.x + rect.width && point.y >= rect.y && point.y < rect.y + rect.height);
		},
	
		// ----------
		distance: function(point1, point2) {
		  var diffX = point1.x - point2.x;
		  var diffY = point1.y - point2.y;
		  return Math.sqrt((diffX * diffX) + (diffY * diffY));
		},
	
		// ----------
		intersection: function(rect1, rect2) {
			var left = Math.max(rect1.x, rect2.x);
			var top = Math.max(rect1.y, rect2.y);
			var right = Math.min(rect1.x + rect1.width, rect2.x + rect2.width);
			var bottom = Math.min(rect1.y + rect1.height, rect2.y + rect2.height);
	
			if (bottom > top && right > left) {
			  return new OpenSeadragon.Rect(left, top, right - left, bottom - top);
			}
	
			return null;
		},
	
		// ----------
		sign: function(value) {
		  return value > 0 ? 1 : (value < 0 ? -1 : 0);
		},
	
		// ----------
		spin: function(value) {
		  if (value) {
			this.spinner = new Spinner({
			  color: '#fff'
			}).spin($("body")[0]);
		  } else {
			this.spinner.stop();
		  }
		}
	  };
	
	  // ----------
	  /*
	  window.addEventListener("resize", function() {
		App.init();
	  });
	  */
	})();
	
	</script>
</body>
</html5>